---
layout: post
title: 实现一个mini-vue
subtitle: 复习vue响应式原理
date: 2021-4-5
author:
header-img:
catalog: true
tags:
  - node
typora-root-url: ..
---

## 用 node 实现一个自动发送邮件脚本

直接上代码：

```javascript
/*main.js*/

const http = require("http");
const fs = require("fs");
const path = require("path");

const superagent = require("superagent");
const cheerio = require("cheerio");
const nodemailer = require("nodemailer");
const ejs = require("ejs");
require("dotenv").config();

const { USER, PASS } = process.env;
const MemeryDay = "2020-10-02";
const ToEmailAddress = "youremile"; //邮件目标地址

const oneUrl = "http://wufazhuce.com/"; //one地址
const watherUrl = "https://www.qweather.com/"; //天气地址

/**
 *
 * @param {String} url
 * @returns Promise<todayOneData> One数据
 */
async function getOneData(url) {
  return new Promise((resolve, reject) => {
    superagent.get(url, (err, res) => {
      if (err) reject(err);
      const $ = cheerio.load(res.text);
      const todayOne = $("#carousel-one .carousel-inner .item")[0];
      const todayOneData = {
        image: $(".fp-one-imagen", todayOne).attr("src"),
        type: $(".fp-one-imagen-footer", todayOne).text().replace(/\s/g, ""),
        text: $(".fp-one-cita a", todayOne).text(),
      };
      resolve(todayOneData);
    });
  });
}

/**
 *
 * @param {String} url
 * @returns Promise<watherData> 天气数据
 */
async function getWatherData(url) {
  return new Promise((resolve, reject) => {
    superagent.get(url, (err, res) => {
      if (err) reject(err);
      const $ = cheerio.load(res.text);
      const todayInfo = [];
      $(".c-index-now__basic .now-basic-container").each((i, x) => {
        todayInfo.push({
          img: $("img", x).attr("src"),
          des: {
            value: $(".basic-item__value", x).text(),
            type: $("basic-item__type", x).text(),
          },
        });
      });
      const watherData = {
        advice: $(".c-index-now__abstract a ").text(),
        todayInfo,
      };
      resolve(watherData);
    });
  });
}

/**
 * 获取所有数据并发送邮件
 */
async function getAllDataAndSendEmail() {
  let htmlData = {};
  const today = new Date();
  const initDay = new Date(MemeryDay);
  const lastDay = Math.floor((today - initDay) / 1000 / 60 / 60 / 24);
  const todaystr =
    today.getFullYear() +
    " / " +
    (today.getMonth() + 1) +
    " / " +
    today.getDate();
  htmlData["lastDay"] = lastDay;
  htmlData["todaystr"] = todaystr;

  Promise.all([getOneData(oneUrl), getWatherData(watherUrl)])
    .then((res) => {
      htmlData.todayOneData = res[0];
      htmlData.watherData = res[1];
      sendMail(htmlData);
    })
    .catch((err) => {
      getAllDataAndSendEmail();
      console.log(err);
    });
}

/**
 *
 * @param {HtmlData} 发送邮件的内容
 */
async function sendMail(HtmlData) {
  //生成HTML模板
  const template = ejs.compile(
    fs.readFileSync(path.resolve(__dirname, "main.ejs"), "utf8")
  );

  //将数据替换到模板中
  const html = template(HtmlData);

  //配置邮箱相关
  const transporter = nodemailer.createTransport({
    service: "126",
    port: 465,
    secure: true,
    auth: {
      user: USER,
      pass: PASS, //smtp授权码，到邮箱设置下获取
    },
  });

  let mailOptions = {
    from: `"liou" <${USER}>`, // 发送者昵称和地址
    to: ToEmailAddress, // 接收者的邮箱地址
    subject: "一封暖暖的小邮件", // 邮件主题
    // text: 'test mail',  //邮件的text
    html: html, //也可以用html发送
  };
  console.log("正在发送邮件。。。");
  //发送邮件
  transporter.sendMail(mailOptions, (error, info) => {
    if (error) {
      sendMail(HtmlData);
      return console.log(error);
    }
    console.log("邮件发送成功 ID：", info);
    console.log("等待下一次发送");
  });
}

/**
 * 每天固定时间发送
 */
setInterval(function () {
  const refreshHours = new Date().getHours();
  const refreshMin = new Date().getMinutes();
  const refreshSec = new Date().getSeconds();
  if (refreshHours === 7 && refreshMin === 00 && refreshSec === 00) {
    getAllDataAndSendEmail();
  }
}, 1000);
```

下面是模板代码：

```html
<!-- main.ejs -->

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="referrer" content="no-referrer" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Document</title>
    <style>
      .title {
        text-align: center;
        font-size: 16px;
        font-weight: 500;
      }

      .title span {
        font-size: 20px;
        font-weight: 700;
        color: #c0392b;
      }

      .advice {
        text-align: center;
      }

      .watherInfo {
        display: flex;
        justify-content: center;
        margin: 20px 0;
        /* background-color: #bdc3c7;
            border-radius: 10px; */
      }

      .infoItem {
        display: flex;
        align-items: center;
      }

      .infoItem img {
        width: 40px;
        height: 40px;
      }

      .watherInfo > div {
        margin-right: 30px;
      }

      .oneInfo {
        display: flex;
        align-items: center;
        flex-direction: column;
      }
    </style>
  </head>

  <body>
    <div class="title">
      今天是我们在一起的第 <span> <%= lastDay %> </span> 天
    </div>
    <br />
    <br />
    <div class="advice"><%= watherData.advice %></div>
    <div class="watherInfo">
      <% watherData.todayInfo.forEach(x=>{ { %>
      <div class="infoItem">
        <div>
          <img src=" <%=x.img %>" alt="" />
        </div>
        <div>
          <div><%=x.des.type %></div>
          <div><%=x.des.value %></div>
        </div>
      </div>
      <% } }) %>
    </div>
    <div class="oneInfo">
      <div style="margin:18px 0">ONE·一个</div>
      <div style="font-size:14px;color:#333"><%=lastDay %></div>
      <div style="text-align: center; margin: 14px 0; width:250px">
        <img
          style="height:300px;width:250px"
          src="<%=todayOneData.image %>"
          alt=""
        />
        <div style="margin: 14px 0;color:#444"><%=todayOneData.type %></div>
        <div style="font-size: 14px; color:#444"><%=todayOneData.text %></div>
      </div>
    </div>
  </body>
</html>
```

此时已经大功告成了，我们只需要执行`node ./main.js`
脚本就会自动帮我们定时发送不同的邮件，效果图如下：
![效果图](https://static01.imgkr.com/temp/315f65ed47e14bc0a15e0ea821b459d2.png)
